<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<link href="css/weibo.css" rel="stylesheet" type="text/css" />
		<script type="text/javascript" src="js/jquery-1.12.4.js"></script>
		<script type="text/javascript">
			$(function() {
				var Text = $('#tijiaoText');
				var btn = $('#btn1');
				var content = $('#div1');
				var page = $('.page');
				var newPage = 0;
				var p = 0;
				var hash = window.location.hash;
				if(hash){
					window.location.hash = 'page=1';
				}else{
					window.location.hash = 'page=1';
				}
				
				btn.on('click', function() {
					var val = Text.val();
					if(!val) {
						alert('请输入内容！');
						return
					}
					/*
					 	weibo.php?act=add&content=xxx	添加一条
						返回：{error:0, id: 新添加内容的ID, time: 添加时间}						 						 
					*/
					$.ajax({
						url: 'php/weibo.php?act=add&content=' + val,
						type: 'get',
						success: function(data) {
							var json = eval('(' + data + ")");
							if(!json.error) { // 成功
								//点击提交以后，认为的把hash值变为第一页；
								window.location.hash = 'page=1';	
								var newDiv = creatDiv(json.time, val, json.id, 0, 0);
								content.prepend(newDiv);
								getPage();	
							}
						}
					})
					Text.val('');
				})				
				/*
				 特殊键提交
				 */
				Text.on('keyup',function(ev){
					if(ev.which == 13 && ev.ctrlKey){
						//  触发器,触发btn按钮的点击事件						
						btn.trigger('click');	
					}
				})
				
				/*
				 	weibo.php?act=get&page=1		获取一页数据
					返回：[{id: ID, content: "内容", time: 时间戳, acc: 顶次数, ref: 踩次数}, {...}, ...]
				 */
				pegeFn(1);
				function pegeFn(n){  // 获取某一页的数据函数
					$.ajax({
						url: 'php/weibo.php?act=get&page='+n,
						type: 'get',
						success: function(data) {
							content.html('');
							var arr = eval('(' + data + ")");
							for(var i = 0; i < arr.length; i++){
								var newDiv = creatDiv(arr[i].time, arr[i].content, arr[i].id, arr[i].acc, arr[i].ref);
								content.append(newDiv);
							}
						}
					})
				}
								
				/*
				 	weibo.php?act=get_page_count	获取页数
					返回：{count:页数}
				*/
				getPage();
				function getPage(){
					$.ajax({
						url:'php/weibo.php?act=get_page_count',
						type:'get',
						success:function(data){
							page.html('');
							var json = eval('(' + data + ")");
							if(json.count >= 7){
								if(p<4){
								p=4
								}else if(p>json.count-3){
									p = json.count-3;
								}					
								for(var i=(p-3);i<=(p+3);i++){
									var oA = $('<a href="javascript:;">'+(i)+'</a>');
									oA.on('click',function(){
										window.location.hash = 'page='+$(this).html();
									})			
									page.append(oA);
								}
							}else{
								for(var i=0;i<json.count;i++){
									var oA = $('<a href="javascript:;">'+(i+1)+'</a>');
									oA.on('click',function(){
										window.location.hash = 'page='+$(this).html();
									})			
									page.append(oA);
								}
							}
							var xz = window.location.hash.split('=')[1];
							if(xz > json.count){
								window.location.hash = 'page='+json.count;
							}
							console.log(json)
							
							page.find('a').each(function(i,ele){
								if($(ele).html() == newPage){
									$(ele).addClass('active').siblings('a').removeClass('active');
								}
							})
						}
					})
				}			
				//  hash只改变，触发事件				
				window.onhashchange = function(){					
					newPage = window.location.hash.split('=')[1];
					newPage = parseInt(newPage);
					pegeFn(newPage);
					p = newPage
					getPage();
					page.find('a').each(function(i,ele){
						if($(ele).html() == newPage){
							$(ele).addClass('active').siblings('a').removeClass('active');
						}
					})
				}

				function creatDiv(time, val, id, up, down) {
					var newDate = new Date(time * 1000);
					var year = newDate.getFullYear();
					var iM = newDate.getMonth() + 1;
					var ri = newDate.getDate();
					var iH = newDate.getHours();
					var iMon = newDate.getMinutes();
					var iS = newDate.getSeconds();
					var str = toD(year)+'-'+toD(iM)+'-'+toD(ri)+' ' +toD(iH)+':'+toD(iMon)+':'+toD(iS);
					//2017-02-6 16:37:60
					var newDiv = $('<div class="reply"></div>');
					var html = '<p class="replyContent">' + val + '</p>' +
						'<p class="operation">' +
							'<span class="replyTime">' + str + '</span>' +
							'<span class="handle">' +
								'<a href="javascript:;" class="top">' + up + '</a>' +
								'<a href="javascript:;" class="down_icon">' + down + '</a>' +
								'<a href="javascript:;" class="cut" dataset.id=' + id + '>删除</a>' +
							'</span>' +
						'</p>';
					newDiv.html(html);
					/*
					 	点击点赞一条数据
				     	weibo.php?act=acc&id=num	顶某一条数据
						返回：{error:0}
					*/
					
					var upBtn = newDiv.find('.top');
										
			upBtn.on('click', function(){
				var arr = document.cookie.split('; ');
				var arr2=[];
				var pat = new RegExp('name'+id);
				for(var i=0;i<arr.length;i++){
					if(pat.test(arr[i])){
						alert('已经点赞')
					}else{
						arr2.push(1);
						if(arr2.length==arr.length){
							var num = $(this).html();
							num++;
							$(this).html(num);
							$.ajax({
								url: 'php/weibo.php?act=acc&id=' + id,
								type: 'get',
								success: function(data){
								}
							})
							var oDate = new Date();
							oDate.setDate(oDate.getDate()+1) 
							document.cookie = 'name'+id+'=id;expires='+oDate;
						}
					}
				}										
			})				
					/*
					 	点击踩一条数据
					 	weibo.php?act=ref&id=num			踩某一条数据
						返回：{error:0} 
					*/
			var downBtn = newDiv.find('.down_icon');
			downBtn.on('click', function(){
				var arr1 = document.cookie.split('; ');
				var arr3=[];
				var pat1 = new RegExp('name'+id);
				for(var i=0;i<arr1.length;i++){
					if(pat1.test(arr1[i])){
						alert('已经踩过')
					}else{
						arr3.push(1);
						if(arr3.length==arr1.length){
							var num2 = $(this).html();
							num2++;
							$(this).html(num2);
							$.ajax({
								url: 'php/weibo.php?act=ref&id=' + id,
								type: 'get',
								success: function(data){
									console.log(data);
								}
							})
							var oDate1 = new Date();
							oDate1.setDate(oDate1.getDate()+1) 
							document.cookie = 'name'+id+'=id;expires='+oDate1;
						}	
					}
				}
			})
					
					/*
					 * 	点击删除一条数据
					 	weibo.php?act=del&id=num			删除某一条数据
						返回：{error:0}
					 */
			var cut = newDiv.find('.cut');				
			cut.on('click',function(){
				$.ajax({
					type:"get",
					url:"php/weibo.php?act=del&id="+id,
					success:function(data){
						//重新再从后台获取数据在渲染到页面
						var c = window.location.hash.split('=')[1];
						pegeFn(c);
						getPage();
					}
				});
			})
			return newDiv;
		}
				
				/*
				 		7  
				 	1-7       3
				 	
				 		n
				 	6-3	 6  6+3
				 	7-3  7  7+3
				 	n-3  n  n+3
				 	for(var i=n-3;i<n+3)
				 * 
				 * 
				 * 
				*/



		function toD(n) {
			return n = n >= 10 ? '' + n : '0' + n;
			}
		})
		</script>
	</head>

	<body>
		<div class="znsArea">
			<!--留言-->
			<div class="takeComment">
				<textarea name="textarea" class="takeTextField" id="tijiaoText"></textarea>
				<div class="takeSbmComment">
					<input type="button" id="btn1" class="inputs" value="" />
					<span>(可按 Enter 回复)</span>
				</div>
			</div>
			<!--已留-->
			<div class="commentOn">
				<div class="messList" id="div1" style="height:502px">
				</div>
				<div class="page">
					<a href="javascript:;" class="active">1</a>
					<a href="javascript:;">2</a>
					<a href="javascript:;">3</a>
				</div>
			</div>
		</div>
	</body>

</html>